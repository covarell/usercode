process REDUCE = {
 
	service = MessageLogger { 
		# REPLACELOG  
		untracked vstring categories = { "Alignment" }
		
		untracked PSet cout    = { 
			untracked string threshold = "DEBUG" 
			untracked bool noLineBreaks = true 
		}
		untracked PSet alignment  = { 
			untracked string threshold = "DEBUG" 
			untracked PSet INFO = { untracked int32 limit = 0 }
			untracked PSet WARNING = { untracked int32 limit = 0 }
			untracked PSet ERROR = { untracked int32 limit = 0 }
			untracked PSet DEBUG = { untracked int32 limit = -1 }
			untracked PSet Alignment = { untracked int32 limit = -1}
			untracked bool noLineBreaks = true 
		}
	}
	
        ################## General settings #####################
	# no magnetic field
	include "MagneticField/Engine/data/volumeBasedMagneticField.cfi"
	include "MagneticField/Engine/data/uniformMagneticField.cfi"
        es_prefer = UniformMagneticFieldESProducer{}
        replace UniformMagneticFieldESProducer.ZFieldInTesla = 0.0

	# ideal geometry and interface
	include "Geometry/CMSCommonData/data/cmsIdealGeometryXML.cfi"
        # include "Geometry/TrackerGeometryBuilder/data/trackerGeometry.cfi"
	include "Geometry/TrackerNumberingBuilder/data/trackerNumberingGeometry.cfi"
	include "RecoTracker/GeometryESProducer/data/TrackerRecoGeometryESProducer.cfi"

        include "RecoLocalTracker/SiStripRecHitConverter/data/SiStripRecHitMatcher.cfi"
        include "RecoLocalTracker/SiStripRecHitConverter/data/SiStripRecHitConverter.cfi"
        #stripCPE
        include "RecoLocalTracker/SiStripRecHitConverter/data/StripCPEfromTrackAngle.cfi"
        #pixelCPEs
        include "RecoLocalTracker/SiPixelRecHits/data/PixelCPEParmError.cfi"
        #TransientTrackingBuilder
        include "RecoTracker/TransientTrackingRecHit/data/TransientTrackingRecHitBuilder.cfi"
        #MeasurementTracker
        include "RecoTracker/MeasurementDet/data/MeasurementTrackerESProducer.cfi"
        replace MeasurementTracker.pixelClusterProducer = ""
        include "RecoTracker/CkfPattern/data/CkfTrajectoryBuilderESProducer.cfi"

        ############### APE setting ###################################
        es_prefer = MisalignedTrackerESProducer{}
        es_module = MisalignedTrackerESProducer {
	  untracked bool dumpBefore  = false  // This is actually the default
	  untracked bool dumpAfter   = false  // This is actually the default
 	  untracked bool saveToDbase = false  // This is actually the default
	
          string distribution = 'fixed'
	  int32 seed = 1234567
	  bool setError = true
          double scale = 0.00001
          double scaleError = 100000
          
          PSet TIBs = { 
            PSet DetUnits = { double dX = 0.1 double dY = 0.1 double dZ = 0.1 }
          }

          PSet TOBs = { 
            PSet DetUnits = { double dX = 0.1 double dY = 0.1 double dZ = 0.1 }
          }
          
        }

        ############### Combinatorial Track Finder ###########################

        module combinatorialseedfinderRED = CombinatorialSeedGeneratorForCosmics {
         InputTag matchedRecHits = siStripMatchedRecHits:matchedRecHit
         InputTag rphirecHits    = siStripMatchedRecHits:rphiRecHit
         InputTag stereorecHits  = siStripMatchedRecHits:stereoRecHit
         double SeedMomentum = 1    #initial momentum in GeV !!!	
         untracked string GeometricStructure  = "CkfTIF3"  #/other options: CkfTIBD+ 
         string Matcher = "StandardMatcher"
         bool UseScintillatorsConstraint = false
         PSet UpperScintillatorParameters = {
           double WidthInX = 500      #half dimension in global X
           double LenghtInZ = 500	   #half dimension in global Z	
           double GlobalX = 0         #scintillator's center position in global X
           double GlobalY = 300       #scintillator's center position in global Y
           double GlobalZ = 50        #scintillator's center position in global Z  
         }
         PSet LowerScintillatorParameters = {
           double WidthInX = 500      #half dimension in global X
           double LenghtInZ = 500     #half dimension in global Z
           double GlobalX = 0         #scintillator's center position in global X
           double GlobalY = -100      #scintillator's center position in global Y
           double GlobalZ = 50        #scintillator's center position in global Z
         }
       }
       
       include "RecoTracker/CkfPattern/data/CkfTrackCandidates.cff"
       
       replace ckfTrackCandidates.TrajectoryBuilder    = "GroupedCkfTrajectoryBuilder"
       replace ckfTrackCandidates.SeedProducer         = "combinatorialseedfinderRED"
       replace GroupedCkfTrajectoryBuilder.ptCut               = 0.01
       replace GroupedCkfTrajectoryBuilder.maxLostHit          = 3
       replace GroupedCkfTrajectoryBuilder.maxConsecLostHit    = 1
       replace GroupedCkfTrajectoryBuilder.minimumNumberOfHits = 4
       
       # final fit
       module ctfWithMaterialTracksRED = TrackProducer {
         string Fitter = "KFFittingSmoother"
         string Propagator = "PropagatorWithMaterial"
         string src = "ckfTrackCandidates"
         string producer = ""
         string TTRHBuilder       =   "WithTrackAngle"
         bool TrajectoryInEvent = true
       }
       
       # track info
       include "AnalysisAlgos/TrackInfoProducer/data/TrackInfoProducer.cfi"
      

       #################### Selection Cuts ###############################
       # selection for alignment
       module alignmentfilter = AlignmentCosmicFilter {
         	InputTag seedTag = combinatorialseedfinderRED:

	 	bool applySeedNumber = true
	 	int32 minNSeeds  = 0
	 	int32 maxNSeeds  = 200
 
	        InputTag trackTag = ctfWithMaterialTracksRED:
		
		bool applyBasicCuts = true
		double ptMin   = 0.0 
		double ptMax   = 600.0
		double etaMin  = -0.6
		double etaMax  =  0.4
		double phiMin  = -1.8
		double phiMax  = -1.2
		double nHitMin =  10
		double nHitMax = 99
		double chi2nMax = 1100.
                PSet minHitsPerSubDet = {
                   untracked int32 inTIB = 2
                   untracked int32 inTOB = 6
                }
		
		bool applyMultiplicityFilter = true
		int32 minMultiplicity = 1
        	int32 maxMultiplicity = 1    
	}

	########################### input files       
        # REPLACEIN

        module out = PoolOutputModule {

          # REPLACEOUT

          untracked vstring outputCommands = {
	    "keep *",
            "drop FEDRawDataCollection_*__*",
            "drop SiStripDigiCollection_*_*_*",
            # "drop SiStripClusteredmDetSetVector_*_*_*",
	    "drop SiStripDigiedmDetSetVector_*_*_*",
	    "drop SiStripRawDigiedmDetSetVector_*_*_*",
            "drop SiStripEventSummary_*_*_*",
            "drop edmTriggerResults_*_*_*",
            "drop RoadSearchClouds_*_*_*"
          }

          untracked PSet SelectEvents = {
             vstring SelectEvents = { "p1" }
          }


        }
        
        ########## The path ###############################
        # For CombinatorialTF
        path p0 = { combinatorialseedfinderRED, ckfTrackCandidates, ctfWithMaterialTracksRED } 
        path p1 = { alignmentfilter }
        endpath p2 = { out }

}

